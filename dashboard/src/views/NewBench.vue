<template>
	<WizardCard>
		<div>
			<h1 class="mb-6 text-2xl font-bold sm:text-center">New Bench</h1>
			<div v-if="$resources.options.loading" class="flex justify-center">
				<Loading />
			</div>
			<div class="space-y-8 sm:space-y-6" v-else>
				<div>
					<label class="text-lg font-semibold">
						Choose a name for your bench
					</label>
					<p class="text-base text-gray-700">
						Name your bench based on it's purpose. For e.g., Personal Websites,
						Staging Bench, etc.
					</p>
					<Input class="mt-4" type="text" v-model="benchTitle" />
				</div>
				<div>
					<label class="text-lg font-semibold">
						Select a Frappe version
					</label>
					<p class="text-base text-gray-700">
						Select a Frappe version for your bench.
					</p>
					<Input
						class="mt-4"
						type="select"
						v-model="selectedVersionName"
						:options="versionOptions"
					/>
				</div>

				<div v-if="selectedVersionName">
					<label class="text-lg font-semibold">
						Select apps to install
					</label>
					<p class="text-base text-gray-700">
						These apps will be available for sites on your bench. You can also
						add apps to your bench later.
					</p>
					<div class="mt-4">
						<AppSourceSelector
							:apps="selectedVersion.apps"
							:value.sync="selectedApps"
							:multiple="true"
						/>
					</div>
				</div>
				<div>
					<label class="text-lg font-semibold">
						Choose a plan
					</label>
					<p class="text-base text-gray-700">
						Select a plan based on the type of usage you are expecting on your
						bench.
					</p>
					<div class="mt-4">
						<TableOptionSelector
							v-bind="benchPlanOptions"
							v-model="selectedPlan"
						/>
					</div>
				</div>
				<div>
					<ErrorMessage class="mb-2" :error="$resources.createBench.error" />
					<Button
						type="primary"
						:loading="$resources.createBench.loading"
						@click="$resources.createBench.submit()"
					>
						Create Bench
					</Button>
				</div>
			</div>
		</div>
	</WizardCard>
</template>

<script>
import WizardCard from '@/components/WizardCard.vue';
import AppSourceSelector from '@/components/AppSourceSelector.vue';
import TableOptionSelector from '../components/TableOptionSelector.vue';
export default {
	name: 'NewBench',
	components: {
		WizardCard,
		AppSourceSelector,
		TableOptionSelector
	},
	data() {
		return {
			benchTitle: null,
			selectedVersionName: null,
			selectedApps: [],
			selectedPlan: null
		};
	},
	resources: {
		options() {
			return {
				method: 'press.api.bench.options',
				default: {
					versions: [],
					plans: []
				},
				auto: true,
				onSuccess(options) {
					if (!this.selectedVersionName) {
						this.selectedVersionName = options.versions[0].name;
					}
				}
			};
		},
		createBench() {
			return {
				method: 'press.api.bench.new',
				params: {
					bench: {
						title: this.benchTitle,
						version: this.selectedVersionName,
						apps: this.selectedApps.map(app => ({
							name: app.app,
							source: app.source.name
						})),
						plan: this.selectedPlan?.name
					}
				},
				validate() {
					if (!this.benchTitle) {
						return 'Bench Title cannot be blank';
					}
					if (!this.selectedVersionName) {
						return 'Select a version to create bench';
					}
					if (this.selectedApps.length < 1) {
						return 'Select atleast one app to create bench';
					}
					if (!this.selectedPlan) {
						return 'Please choose a plan';
					}
				},
				onSuccess(benchName) {
					this.$router.push(`/benches/${benchName}`);
				}
			};
		}
	},
	watch: {
		selectedVersionName() {
			this.$nextTick(() => {
				let frappeApp = this.getFrappeApp(this.selectedVersion.apps);
				this.selectedApps = [{ app: frappeApp.name, source: frappeApp.source }];
			});
		},
		selectedApps(newVal, oldVal) {
			// dont remove frappe app
			let hasFrappe = newVal.find(app => app.app === 'frappe');
			if (!hasFrappe && oldVal) {
				this.selectedApps = oldVal;
			}
		}
	},
	methods: {
		getFrappeApp(apps) {
			return apps.find(app => app.name === 'frappe');
		}
	},
	computed: {
		options() {
			return this.$resources.options.data;
		},
		selectedVersion() {
			return this.options.versions.find(
				v => v.name === this.selectedVersionName
			);
		},
		versionOptions() {
			return this.options.versions.map(v => ({
				label: `${v.name} (${v.status})`,
				value: v.name
			}));
		},
		benchPlanOptions() {
			let plans = this.options ? this.options.plans : [];
			plans = plans.map(plan => {
				let title = this.$planTitle(plan);
				return {
					...plan,
					title: `${title} /mo`
				};
			});
			return {
				header: [{ label: 'Plan', fieldname: 'title' }],
				options: plans
			};
		}
	}
};
</script>
