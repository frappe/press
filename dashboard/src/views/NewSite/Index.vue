<template>
	<WizardCard v-if="options">
		<div class="mb-6 text-center ">
			<h1 class="text-2xl font-bold">
				Create a new site
			</h1>
			<p v-if="benchTitle" class="text-base text-gray-700">
				Site will be created on bench
				<span class="font-medium">{{ benchTitle }}</span>
			</p>
		</div>
		<Steps :steps="steps">
			<template
				v-slot="{
					active: activeStep,
					next,
					previous,
					hasPrevious,
					hasNext
				}"
			>
				<div class="mt-8"></div>
				<Hostname
					:options="options"
					v-show="activeStep.name === 'Hostname'"
					v-model="subdomain"
					@error="error => (subdomainValid = !Boolean(error))"
				/>
				<Apps
					:options="options"
					v-show="activeStep.name === 'Apps'"
					:privateBench="privateBench"
					:selectedApps.sync="selectedApps"
					:selectedGroup.sync="selectedGroup"
				/>
				<Restore
					:options="options"
					:selectedFiles.sync="selectedFiles"
					v-show="activeStep.name == 'Restore'"
				/>
				<Plans
					:selectedPlan.sync="selectedPlan"
					:options="options"
					v-show="activeStep.name === 'Plan'"
				/>
				<div class="mt-4">
					<ErrorMessage :error="$resources.newSite.error" />
					<div class="flex justify-between">
						<Button
							@click="previous"
							:class="{
								'opacity-0 pointer-events-none': !hasPrevious
							}"
						>
							Back
						</Button>
						<Button
							v-show="activeStep.name !== 'Restore' || wantsToRestore"
							type="primary"
							@click="next"
							:class="{
								'opacity-0 pointer-events-none': !hasNext
							}"
						>
							Next
						</Button>
						<Button
							v-show="!wantsToRestore && activeStep.name === 'Restore'"
							type="primary"
							@click="next"
						>
							Skip
						</Button>
						<Button
							v-show="!hasNext"
							type="primary"
							@click="$resources.newSite.submit()"
							:loading="$resources.newSite.loading"
						>
							Create Site
						</Button>
					</div>
				</div>
			</template>
		</Steps>
	</WizardCard>
</template>

<script>
import WizardCard from '@/components/WizardCard.vue';
import Steps from '@/components/Steps.vue';
import Hostname from './Hostname.vue';
import Apps from './Apps.vue';
import Restore from './Restore.vue';
import Plans from './Plans.vue';

export default {
	name: 'NewSite',
	components: {
		WizardCard,
		Steps,
		Hostname,
		Apps,
		Restore,
		Plans
	},
	data() {
		return {
			subdomain: null,
			subdomainValid: false,
			options: null,
			privateBench: false,
			benchTitle: null,
			selectedApps: [],
			selectedGroup: null,
			selectedFiles: {
				database: null,
				public: null,
				private: null
			},
			selectedPlan: null,
			steps: [
				{
					name: 'Hostname',
					validate: () => {
						return this.subdomainValid;
					}
				},
				{
					name: 'Apps'
				},
				{
					name: 'Restore'
				},
				{
					name: 'Plan'
				}
			]
		};
	},
	async mounted() {
		this.options = await this.$call('press.api.site.options_for_new');
		this.options.plans = this.options.plans.map(plan => {
			plan.disabled = this.disablePlan(plan);
			return plan;
		});

		if (this.$route.query.domain) {
			let domain = this.$route.query.domain.split('.');
			if (domain) {
				this.subdomain = domain[0];
			}
			this.$router.replace({});
		}
		if (this.$route.query.bench) {
			this.privateBench = true;
			this.selectedGroup = this.$route.query.bench;
			this.benchTitle = this.$route.query.benchTitle;
			this.$router.replace({});
		}
	},
	resources: {
		newSite() {
			return {
				method: 'press.api.site.new',
				params: {
					site: {
						name: this.subdomain,
						apps: this.selectedApps,
						group: this.selectedGroup,
						plan: this.selectedPlan ? this.selectedPlan.name : null,
						files: this.selectedFiles
					}
				},
				onSuccess(data) {
					let { site, job = '' } = data;
					this.$router.push(`/sites/${site}/jobs/${job}`);
				},
				validate() {
					let canCreate =
						this.subdomainValid &&
						this.selectedApps.length > 0 &&
						this.selectedPlan &&
						(!this.wantsToRestore ||
							Object.values(this.selectedFiles).every(v => v));

					if (!canCreate) {
						return 'Cannot create site';
					}
				}
			};
		}
	},
	methods: {
		disablePlan(plan) {
			if (this.options.free_account) {
				return false;
			}
			if (this.options.allow_partner) {
				return false;
			}
			if (this.options.has_card) {
				return false;
			}
			if (this.options.disable_site_creation) {
				return true;
			}
			return true;
		}
	},
	computed: {
		wantsToRestore() {
			let {
				database,
				public: publicFile,
				private: privateFile
			} = this.selectedFiles;
			if (!(database && publicFile && privateFile)) {
				return false;
			}
			return true;
		}
	}
};
</script>
