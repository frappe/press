<template>
	<div
		class="flex h-screen w-screen flex-col items-center justify-center bg-gray-600 bg-opacity-50"
		v-if="$resources?.siteRequest?.doc?.status !== 'Error'"
	>
		<div class="mb-2 animate-spin">
			<svg
				width="22"
				height="22"
				viewBox="0 0 22 22"
				fill="none"
				xmlns="http://www.w3.org/2000/svg"
			>
				<g
					clip-path="url(#paint0_angular_188_13069_clip_path)"
					data-figma-skip-parse="true"
				>
					<g transform="matrix(-0.002 -0.012 0.012 -0.002 11 11)">
						<foreignObject
							x="-1135.14"
							y="-1135.14"
							width="2270.27"
							height="2270.27"
							><div
								xmlns="http://www.w3.org/1999/xhtml"
								style="
									background: conic-gradient(
										from 90deg,
										rgba(255, 255, 255, 0.0018) 0deg,
										rgba(255, 255, 255, 1) 260.571deg,
										rgba(255, 255, 255, 0) 359.525deg,
										rgba(255, 255, 255, 0.0018) 360deg
									);
									height: 100%;
									width: 100%;
									opacity: 1;
								"
							></div
						></foreignObject>
					</g>
				</g>
				<path
					d="M12 1C12 0.447715 11.5523 0 11 0C10.4477 0 10 0.447715 10 1H12ZM10 5C10 5.55228 10.4477 6 11 6C11.5523 6 12 5.55228 12 5H10ZM12 17C12 16.4477 11.5523 16 11 16C10.4477 16 10 16.4477 10 17H12ZM10 21C10 21.5523 10.4477 22 11 22C11.5523 22 12 21.5523 12 21H10ZM5 12C5.55228 12 6 11.5523 6 11C6 10.4477 5.55228 10 5 10V12ZM1 10C0.447715 10 0 10.4477 0 11C0 11.5523 0.447715 12 1 12V10ZM21 12C21.5523 12 22 11.5523 22 11C22 10.4477 21.5523 10 21 10V12ZM17 10C16.4477 10 16 10.4477 16 11C16 11.5523 16.4477 12 17 12V10ZM17.3713 18.7855C17.7618 19.1761 18.395 19.1761 18.7855 18.7855C19.1761 18.395 19.1761 17.7618 18.7855 17.3713L17.3713 18.7855ZM15.9571 14.5429C15.5666 14.1524 14.9334 14.1524 14.5429 14.5429C14.1524 14.9334 14.1524 15.5666 14.5429 15.9571L15.9571 14.5429ZM18.7855 4.70705C19.1761 4.31652 19.1761 3.68336 18.7855 3.29283C18.395 2.90231 17.7618 2.90231 17.3713 3.29284L18.7855 4.70705ZM14.5429 6.12126C14.1524 6.51179 14.1524 7.14495 14.5429 7.53548C14.9334 7.926 15.5666 7.926 15.9571 7.53548L14.5429 6.12126ZM3.21447 17.3713C2.82394 17.7618 2.82394 18.395 3.21447 18.7855C3.60499 19.1761 4.23815 19.1761 4.62868 18.7855L3.21447 17.3713ZM7.45711 15.9571C7.84763 15.5666 7.84763 14.9334 7.45711 14.5429C7.06658 14.1524 6.43342 14.1524 6.04289 14.5429L7.45711 15.9571ZM4.62868 3.29283C4.23816 2.90231 3.60499 2.90231 3.21447 3.29283C2.82394 3.68336 2.82394 4.31652 3.21447 4.70705L4.62868 3.29283ZM6.04289 7.53548C6.43342 7.926 7.06658 7.926 7.45711 7.53548C7.84763 7.14495 7.84763 6.51179 7.45711 6.12126L6.04289 7.53548ZM10 1V5H12V1H10ZM10 17V21H12V17H10ZM5 10H1V12H5V10ZM21 10H17V12H21V10ZM18.7855 17.3713L15.9571 14.5429L14.5429 15.9571L17.3713 18.7855L18.7855 17.3713ZM17.3713 3.29284L14.5429 6.12126L15.9571 7.53548L18.7855 4.70705L17.3713 3.29284ZM4.62868 18.7855L7.45711 15.9571L6.04289 14.5429L3.21447 17.3713L4.62868 18.7855ZM3.21447 4.70705L6.04289 7.53548L7.45711 6.12126L4.62868 3.29283L3.21447 4.70705Z"
					data-figma-gradient-fill="{&#34;type&#34;:&#34;GRADIENT_ANGULAR&#34;,&#34;stops&#34;:[{&#34;color&#34;:{&#34;r&#34;:1.0,&#34;g&#34;:1.0,&#34;b&#34;:1.0,&#34;a&#34;:1.0},&#34;position&#34;:0.72380936145782471},{&#34;color&#34;:{&#34;r&#34;:1.0,&#34;g&#34;:1.0,&#34;b&#34;:1.0,&#34;a&#34;:0.0},&#34;position&#34;:0.99868124723434448}],&#34;stopsVar&#34;:[],&#34;transform&#34;:{&#34;m00&#34;:-4.0,&#34;m01&#34;:24.0,&#34;m02&#34;:1.0000001192092896,&#34;m10&#34;:-24.0,&#34;m11&#34;:-4.0,&#34;m12&#34;:25.0},&#34;opacity&#34;:1.0,&#34;blendMode&#34;:&#34;NORMAL&#34;,&#34;visible&#34;:true}"
				/>
				<defs>
					<clipPath id="paint0_angular_188_13069_clip_path">
						<path
							d="M12 1C12 0.447715 11.5523 0 11 0C10.4477 0 10 0.447715 10 1H12ZM10 5C10 5.55228 10.4477 6 11 6C11.5523 6 12 5.55228 12 5H10ZM12 17C12 16.4477 11.5523 16 11 16C10.4477 16 10 16.4477 10 17H12ZM10 21C10 21.5523 10.4477 22 11 22C11.5523 22 12 21.5523 12 21H10ZM5 12C5.55228 12 6 11.5523 6 11C6 10.4477 5.55228 10 5 10V12ZM1 10C0.447715 10 0 10.4477 0 11C0 11.5523 0.447715 12 1 12V10ZM21 12C21.5523 12 22 11.5523 22 11C22 10.4477 21.5523 10 21 10V12ZM17 10C16.4477 10 16 10.4477 16 11C16 11.5523 16.4477 12 17 12V10ZM17.3713 18.7855C17.7618 19.1761 18.395 19.1761 18.7855 18.7855C19.1761 18.395 19.1761 17.7618 18.7855 17.3713L17.3713 18.7855ZM15.9571 14.5429C15.5666 14.1524 14.9334 14.1524 14.5429 14.5429C14.1524 14.9334 14.1524 15.5666 14.5429 15.9571L15.9571 14.5429ZM18.7855 4.70705C19.1761 4.31652 19.1761 3.68336 18.7855 3.29283C18.395 2.90231 17.7618 2.90231 17.3713 3.29284L18.7855 4.70705ZM14.5429 6.12126C14.1524 6.51179 14.1524 7.14495 14.5429 7.53548C14.9334 7.926 15.5666 7.926 15.9571 7.53548L14.5429 6.12126ZM3.21447 17.3713C2.82394 17.7618 2.82394 18.395 3.21447 18.7855C3.60499 19.1761 4.23815 19.1761 4.62868 18.7855L3.21447 17.3713ZM7.45711 15.9571C7.84763 15.5666 7.84763 14.9334 7.45711 14.5429C7.06658 14.1524 6.43342 14.1524 6.04289 14.5429L7.45711 15.9571ZM4.62868 3.29283C4.23816 2.90231 3.60499 2.90231 3.21447 3.29283C2.82394 3.68336 2.82394 4.31652 3.21447 4.70705L4.62868 3.29283ZM6.04289 7.53548C6.43342 7.926 7.06658 7.926 7.45711 7.53548C7.84763 7.14495 7.84763 6.51179 7.45711 6.12126L6.04289 7.53548ZM10 1V5H12V1H10ZM10 17V21H12V17H10ZM5 10H1V12H5V10ZM21 10H17V12H21V10ZM18.7855 17.3713L15.9571 14.5429L14.5429 15.9571L17.3713 18.7855L18.7855 17.3713ZM17.3713 3.29284L14.5429 6.12126L15.9571 7.53548L18.7855 4.70705L17.3713 3.29284ZM4.62868 18.7855L7.45711 15.9571L6.04289 14.5429L3.21447 17.3713L4.62868 18.7855ZM3.21447 4.70705L6.04289 7.53548L7.45711 6.12126L4.62868 3.29283L3.21447 4.70705Z"
						/>
					</clipPath>
				</defs>
			</svg>
		</div>
		<!-- <Spinner class="mb-2 w-4" /> -->
		<p class="text-white">Completing setup</p>
	</div>
	<div class="flex h-screen overflow-hidden" v-else>
		<div class="w-full overflow-auto">
			<LoginBox
				v-if="$resources?.siteRequest?.doc?.status === 'Site Created'"
				title="Site created successfully"
				:subtitle="`Your trial site is ready ats
					${$resources?.siteRequest?.doc?.domain || $resources?.siteRequest?.doc?.site}`"
			>
				<template v-slot:logo v-if="saasProduct">
					<div class="flex space-x-2">
						<img
							class="inline-block h-[38px] w-[38px] rounded-sm"
							:src="saasProduct?.logo"
						/>
						<!-- <span
							class="select-none text-xl font-semibold tracking-tight text-gray-900"
						>
							{{ saasProduct?.title }}
						</span> -->
					</div>
				</template>
				<div>
					<div
						class="mb-4 mt-16 flex flex-col items-center justify-center space-y-4"
					>
						<Button
							variant="solid"
							class="w-full"
							icon-right="external-link"
							@click="loginToSite"
							:loading="this.$resources?.siteRequest?.getLoginSid.loading"
						>
							Log In
						</Button>
					</div>
				</div>
				<ErrorMessage
					class="w-full text-center"
					:message="this.$resources?.siteRequest?.getLoginSid.error"
				/>
				<!-- <template v-slot:footer>
					<div
						class="mt-2 flex w-full items-center justify-center text-sm text-gray-600"
					>
						Powered by Frappe Cloud
					</div>
				</template> -->
			</LoginBox>
			<LoginBox
				v-else-if="$resources?.siteRequest?.doc?.status === 'Error'"
				title="Site creation failed"
				:subtitle="
					$resources?.siteRequest?.doc?.domain ||
					$resources?.siteRequest?.doc?.site
				"
			>
				<template v-slot:logo v-if="saasProduct">
					<div class="mx-auto flex items-center space-x-2">
						<img
							class="inline-block h-7 w-7 rounded-sm"
							:src="saasProduct?.logo"
						/>
						<span
							class="select-none text-xl font-semibold tracking-tight text-gray-900"
						>
							{{ saasProduct?.title }}
						</span>
					</div>
				</template>
				<template v-slot:default>
					<div class="flex h-40 flex-col items-center justify-center px-10">
						<div class="text-center text-base leading-5 text-gray-800">
							<p>It looks like something went wrong</p>
							<p>
								Contact
								<a href="mailto:support@frappe.io" class="underline"
									>support@frappe.io</a
								><br />
								to resolve the issue
							</p>
						</div>
					</div>
				</template>
				<!-- <template v-slot:footer>
					<div
						class="mt-2 flex w-full items-center justify-center text-sm text-gray-600"
					>
						Powered by Frappe Cloud
					</div>
				</template> -->
			</LoginBox>
			<LoginBox
				v-else
				title="Creating your site"
				:subtitle="
					this.$resources?.siteRequest?.doc?.domain ||
					this.$resources?.siteRequest?.doc?.site
				"
			>
				<template v-slot:logo v-if="saasProduct">
					<div class="mx-auto flex items-center space-x-2">
						<img
							class="inline-block h-7 w-7 rounded-sm"
							:src="saasProduct?.logo"
						/>
						<span
							class="select-none text-xl font-semibold tracking-tight text-gray-900"
						>
							{{ saasProduct?.title }}
						</span>
					</div>
				</template>
				<template v-slot:default>
					<div class="flex h-40 items-center justify-center">
						<Progress
							class="px-10"
							size="md"
							:value="progressCount"
							:label="currentBuildStep"
						/>
					</div>
				</template>
				<!-- <template v-slot:footer>
					<div
						class="mt-2 flex w-full items-center justify-center text-sm text-gray-600"
					>
						Powered by Frappe Cloud
					</div>
				</template> -->
			</LoginBox>
		</div>
	</div>
</template>
<script>
import LoginBox from '../../components/auth/LoginBox.vue';
import { Progress } from 'frappe-ui';

export default {
	name: 'SignupLoginToSite',
	props: ['productId'],
	components: {
		LoginBox,
		Progress,
	},
	data() {
		return {
			product_trial_request: this.$route.query.product_trial_request,
			progressCount: 0,
			currentBuildStep: 'Preparing for build',
		};
	},
	resources: {
		saasProduct() {
			return {
				type: 'document',
				doctype: 'Product Trial',
				name: this.productId,
				auto: true,
			};
		},
		siteRequest() {
			return {
				type: 'document',
				doctype: 'Product Trial Request',
				name: this.product_trial_request,
				realtime: true,
				auto: true,
				onSuccess(doc) {
					if (doc.status == 'Site Created') this.loginToSite();
					else if (
						doc.status == 'Wait for Site' ||
						doc.status == 'Prefilling Setup Wizard'
					) {
						this.$resources.siteRequest.getProgress.reload();
					}
				},
				whitelistedMethods: {
					getProgress: {
						method: 'get_progress',
						makeParams() {
							return {
								current_progress:
									this.$resources.siteRequest.getProgress.data?.progress || 0,
							};
						},
						onSuccess: (data) => {
							if (data.status === 'Site Created') {
								return this.loginToSite();
							}

							const currentStepMap = {
								'Wait for Site': 'Creating your site',
								'New Site': 'Creating your site',
								'Prefilling Setup Wizard': 'Setting up your site',
								'Update Site Configuration': 'Setting up your site',
								'Enable Scheduler': 'Setting up your site',
								'Bench Setup NGINX': 'Setting up your site',
								'Reload NGINX': 'Setting up your site',
							};

							this.currentBuildStep =
								currentStepMap[data.current_step] ||
								data.current_step ||
								this.currentBuildStep;
							this.progressCount += 1;

							if (
								!(
									this.$resources.siteRequest.getProgress.error &&
									this.progressCount <= 10
								)
							) {
								this.progressCount = Math.round(data.progress * 10) / 10;
								setTimeout(() => {
									// if (
									// 	['Site Created', 'Error'].includes(
									// 		this.$resources.siteRequest.doc.status
									// 	)
									// )
									// 	return;

									this.$resources.siteRequest.getProgress.reload();
								}, 2000);
							}
						},
					},
					getLoginSid: {
						method: 'get_login_sid',
						onSuccess(loginURL) {
							window.open(loginURL, '_self');
						},
					},
				},
			};
		},
	},
	computed: {
		saasProduct() {
			return this.$resources.saasProduct.doc;
		},
	},
	methods: {
		loginToSite() {
			this.$resources.siteRequest.getLoginSid.submit();
		},
	},
};
</script>
