---
- name: Link Input Chain
  ansible.builtin.iptables:
    chain: INPUT
    jump: "{{ chain_main }}"
    state: present
  when: enabled | bool

- name: Link Docker Chain
  ansible.builtin.iptables:
    chain: DOCKER-USER
    jump: "{{ chain_main }}"
    state: present
  when: enabled | bool

- name: Link Output Chain
  ansible.builtin.iptables:
    chain: OUTPUT
    jump: "{{ chain_main }}"
    state: present
  when: enabled | bool

- name: Unlink Input Chain
  ansible.builtin.iptables:
    chain: INPUT
    jump: "{{ chain_main }}"
    state: absent
  when: not (enabled | bool)

- name: Unlink Docker Chain
  ansible.builtin.iptables:
    chain: DOCKER-USER
    jump: "{{ chain_main }}"
    state: absent
  when: not (enabled | bool)

- name: Unlink Output Chain
  ansible.builtin.iptables:
    chain: OUTPUT
    jump: "{{ chain_main }}"
    state: absent
  when: not (enabled | bool)

- name: Clear Existing Rules
  ansible.builtin.iptables:
    chain: "{{ chain_main }}"
    flush: yes

- name: Sync Rules
  ansible.builtin.iptables:
    chain: "{{ chain_main }}"
    source: "{{ item.source | default(omit) }}"
    destination: "{{ item.destination | default(omit) }}"
    match: "conntrack"
    ctstate:
      - NEW
      - ESTABLISHED
    protocol: "{{ item.protocol }}"
    jump: "{{ item.action }}"
  loop: "{{ rules }}"

- name: Sync Bypass Rules
  ansible.builtin.iptables:
    chain: "{{ chain_bypass }}"
    source: "{{ item.source | default(omit) }}"
    destination: "{{ item.destination | default(omit) }}"
    match: "conntrack"
    ctstate:
      - NEW
      - ESTABLISHED
    protocol: "{{ item.protocol }}"
    jump: "{{ item.action }}"
  loop: "{{ rules_bypass }}"

- name: Persist rules across reboots
  ansible.builtin.shell: iptables-save > /etc/iptables/rules.v4
  become: true
